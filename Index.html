<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte interactive des Parcs et Espèces</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      text-align: left;
      margin: 20px 0 0 16px;
      padding: 0;
      z-index: 1002;
    }
    #map {
      width: 95vw;
      max-width: 100%;
      height: 90vh;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin: 20px auto;
    }
    #searchBox {
      position: fixed;
      top: 70px;
      right: 60px;
      z-index: 1001;
      width: 90vw;
      max-width: 500px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      margin-top: 50px;
    }
    #dropdown {
      position: fixed;
      top: 120px;
      right: 60px;
      z-index: 1001;
      width: 90vw;
      max-width: 500px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .dropdown-item:hover {
      background-color: #f9f9f9;
    }
    .leaflet-popup-content {
      width: 500px !important;
      max-height: 400px;
      overflow-y: auto;
    }
    .species-popup-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .species-search {
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    .species-list {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-height: 250px;
      overflow-y: auto;
      padding: 5px;
    }
    @media (max-width: 600px) {
      .species-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .species-item {
      border: 1px solid #ddd;
      padding: 6px;
      border-radius: 6px;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .species-name {
      font-weight: bold;
      cursor: pointer;
      display: block;
    }
    .EX { color: #000000; }
    .EW { color: #660000; }
    .CR { color: #FF0000; }
    .EN { color: #FF6600; }
    .VU { color: #FFCC00; }
    .NT { color: #99CC33; }
    .LC { color: #339900; }
    .DD { color: #CCCCCC; }
    .NE { color: #FFFFFF; background-color: #333; }
    .justified-text {
      text-align: justify;
    }
    .legend {
      position: absolute;
      bottom: 55px;
      right: 55px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 300px;
    }
    .legend h3 {
      margin-top: 0;
      font-size: 16px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      cursor: pointer;
    }
    .legend-item:hover {
      background-color: #f0f0f0;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border: 1px solid #ccc;
    }
    .legend-details {
      display: flex;
      flex-direction: column;
    }
    .legend-stats {
      font-size: 12px;
      color: #666;
    }
    #iucn-legend {
      position: absolute;
      bottom: 200px;
      left: 55px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 200px;
      display: none;
    }
    #iucn-legend h3 {
      margin-top: 0;
      font-size: 16px;
    }
    .iucn-legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .iucn-legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Observatoire des espèces et de la biodiversité dans les espaces verts à Eysines</h2>
  <input type="text" id="searchBox" placeholder="Rechercher un espace ou une espèce...">
  <div id="dropdown"></div>
  <div id="map"></div>
  <div id="legend" class="legend">
    <h3>Légende des Parcs</h3>
    <div id="legend-content"></div>
  </div>
  <div id="iucn-legend">
    <h3>Légende des Statuts IUCN</h3>
    <div id="iucn-legend-content"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const map = L.map('map').setView([44.88, -0.64], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let parkLayers = {};
    let observationsData = [];
    let parkStats = {};
    const iucnLegend = document.getElementById('iucn-legend');
    const dropdown = document.getElementById('dropdown');

    Promise.all([
      fetch("https://raw.githubusercontent.com/Axeloiu/Eysines-/refs/heads/main/LIMITE_EYSINES.geojson").then(res => res.json()),
      fetch("https://raw.githubusercontent.com/Axeloiu/Observ/refs/heads/main/Les%20zones.geojson").then(res => res.json()),
      fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhAv3MoXfTKexc1zMeY-HLTzrnVvLrnBiobQ5x3Yh5h_HXFgb0IWNgV69V8_3mMLt6g97ZWdxSjop0cWnntiILKOI01hLi1dWyn39VLxf2g0Aj1_MkghJcFgNsq1qUiEGNNz0e9FCjQFWdd_-3n8IqLFDd27Z33yjH__BXbimeOQQQlW9jrzOR-2caUtInzgKw07-ZZz9Bzp7LMTTkuD2nYlAT2hxzStkC_BkwoBOp_T3IImR1pZWI8KkxAuVMEWlpyjm2bc-s9oyBhDDM7_m770r4bpw&lib=MNJtwAsUYyBxHxFxRjcTD4V23JKJcw30W").then(res => res.json())
    ]).then(([limitData, zonesData, observations]) => {
      L.geoJSON(limitData, {
        style: {
          color: "blue",
          weight: 4,
          fillOpacity: 0
        }
      }).addTo(map);
      observationsData = observations;
      console.log("Données d'observations chargées:", observationsData);
      L.geoJSON(zonesData, {
        style: function(feature) {
          const parkName = feature.properties.N2 || "Espace sans nom";
          const color = getColorForPark(parkName);
          return {
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.5
          };
        },
        onEachFeature: onEachParkFeature
      }).addTo(map);
      calculateParkStats();
      associateObservationsWithParks();
      addLegend(zonesData);
      addIUCNLegend();
    }).catch(err => console.error("Erreur lors du chargement des données:", err));

    map.on('click', function() {
      iucnLegend.style.display = 'none';
      dropdown.style.display = 'none';
    });

    function getColorForPark(parkName) {
      const parkColors = {
        "Parc du Bourran": "#4CAF50",
        "Parc de Lescombes": "#2196F3",
        "Parc de Pin Galant": "#FFC107",
        "Parc de la Mairie": "#9C27B0",
        "Parc de la Tour": "#FF5722",
        "Parc de la Tuilerie": "#00BCD4",
        "Parc de la Chênaie": "#673AB7",
        "Parc de la Pimpine": "#E91E63",
        "Parc de la Jalle": "#3F51B5",
        "Parc de la Boétie": "#009688"
      };
      return parkColors[parkName] || "#4CAF50";
    }

    function calculateParkStats() {
      parkStats = {};
      observationsData.forEach(observation => {
        const parkName = observation["Nom de l'espace"];
        if (!parkStats[parkName]) {
          parkStats[parkName] = { total: 0, protected: 0 };
        }
        parkStats[parkName].total++;
        if (observation["Espèce protégé ?"] === "Oui") {
          parkStats[parkName].protected++;
        }
      });
      console.log("Statistiques des parcs calculées:", parkStats);
    }

    function addLegend(data) {
      const legendContent = document.getElementById('legend-content');
      legendContent.innerHTML = '';
      const uniqueParks = new Set();
      data.features.forEach(feature => {
        const parkName = feature.properties.N2 || "Espace sans nom";
        if (!uniqueParks.has(parkName)) {
          uniqueParks.add(parkName);
          const color = getColorForPark(parkName);
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.onclick = function() {
            zoomToPark(parkName);
          };
          const legendColor = document.createElement('div');
          legendColor.className = 'legend-color';
          legendColor.style.backgroundColor = color;
          const legendDetails = document.createElement('div');
          legendDetails.className = 'legend-details';
          const legendText = document.createElement('span');
          legendText.textContent = parkName;
          const legendStats = document.createElement('div');
          legendStats.className = 'legend-stats';
          const stats = parkStats[parkName] || { total: 0, protected: 0 };
          const protectedPercentage = stats.total > 0 ? (stats.protected / stats.total * 100).toFixed(2) : 0;
          legendStats.textContent = `Espèces uniques: ${stats.total}, Espèces protégées: ${protectedPercentage}%`;
          legendDetails.appendChild(legendText);
          legendDetails.appendChild(legendStats);
          legendItem.appendChild(legendColor);
          legendItem.appendChild(legendDetails);
          legendContent.appendChild(legendItem);
        }
      });
    }

    function onEachParkFeature(feature, layer) {
      const props = feature.properties || {};
      const parkName = props.N2 || "Espace sans nom";
      layer.bindTooltip(parkName, { permanent: true, direction: "center" });
      layer.on('click', function() {
        iucnLegend.style.display = 'block';
      });
      if (!parkLayers[parkName]) {
        parkLayers[parkName] = [];
      }
      parkLayers[parkName].push(layer);
    }

    function zoomToPark(parkName) {
      if (parkLayers[parkName] && parkLayers[parkName].length > 0) {
        const layer = parkLayers[parkName][0];
        map.fitBounds(layer.getBounds());
      }
    }

    function associateObservationsWithParks() {
      if (!observationsData || observationsData.length === 0) {
        console.error("Aucune donnée d'observation disponible.");
        return;
      }
      const observationsByPark = {};
      observationsData.forEach(observation => {
        const parkName = observation["Nom de l'espace"];
        if (!observationsByPark[parkName]) {
          observationsByPark[parkName] = [];
        }
        observationsByPark[parkName].push(observation);
      });
      Object.keys(observationsByPark).forEach(parkName => {
        if (parkLayers[parkName]) {
          const popupContent = generatePopupContent(observationsByPark[parkName]);
          parkLayers[parkName][0].bindPopup(popupContent);
        } else {
          console.warn(`Aucun parc trouvé pour le nom: ${parkName}`);
        }
      });
    }

    function generatePopupContent(observations) {
      const uniqueId = `popup-${Math.floor(Math.random() * 100000)}`;
      let popupContent = `
        <div class="species-popup-container" id="${uniqueId}">
          <input class="species-search" type="text" placeholder="Rechercher une espèce..." oninput="filterSpecies('${uniqueId}', this.value)">
          <div class="species-list">`;
      observations.forEach(observation => {
        const iucnStatus = observation["Statut IUCN"] || "NE";
        const iucnClass = iucnStatus.split(' ')[0];
        popupContent += `
          <div class="species-item" data-name="${(observation["Nom vernaculaire"] || "").toLowerCase()}" onclick="showSpeciesDetails(${escapeHtml(JSON.stringify(observation))})">
            <div class="species-name ${iucnClass}">
              ${observation["Nom vernaculaire"] || "Espèce non nommée"}
            </div>
          </div>`;
      });
      popupContent += `</div></div>`;
      return popupContent;
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function filterSpecies(popupId, searchValue) {
      const container = document.getElementById(popupId);
      const items = container.querySelectorAll('.species-item');
      const lowerSearch = searchValue.toLowerCase().trim();
      items.forEach(item => {
        const name = item.getAttribute('data-name');
        item.style.display = name.includes(lowerSearch) ? 'block' : 'none';
      });
    }

    function showSpeciesDetails(observation) {
      Swal.fire({
        title: observation["Nom vernaculaire"] || "Espèce non nommée",
        html: `
          <div class="justified-text">
            <b>Groupe / Taxon / Famille:</b> ${observation["Groupe / Taxon / Famille"] || "Non spécifié"}<br>
            <b>Nom scientifique:</b> ${observation["Nom scientifique"] || "Non spécifié"}<br>
            <b>Statut IUCN:</b> ${observation["Statut IUCN"] || "Non spécifié"}<br>
            <b>Déterminante ZNIEFF (Aquitaine):</b> ${observation["Déterminante ZNIEFF (Aquitaine)"] || "Non spécifié"}<br>
            <b>Espèce exotique envahissante ?:</b> ${observation["Espèce exotique envahissante ?"] || "Non spécifié"}<br>
            <b>Date:</b> ${observation["Date"] || "Non spécifié"}<br>
            <b>Observateur:</b> ${observation["Observateur :"] || "Non spécifié"}<br>
            <b>Espèce protégée ?:</b> ${observation["Espèce protégé ?"] || "Non spécifié"}
          </div>
        `,
        width: 600,
        padding: '3em',
        background: '#fff',
      });

      const parkName = observation["Nom de l'espace"];
      if (parkLayers[parkName]) {
        parkLayers[parkName].forEach(layer => {
          map.fitBounds(layer.getBounds());
        });
      }
    }

    function addIUCNLegend() {
      const legendContent = document.getElementById('iucn-legend-content');
      legendContent.innerHTML = '';
      const iucnStatuses = {
        "EX": { name: "Éteint", color: "#000000" },
        "EW": { name: "Éteint à l'état sauvage", color: "#660000" },
        "CR": { name: "En danger critique d'extinction", color: "#FF0000" },
        "EN": { name: "En danger", color: "#FF6600" },
        "VU": { name: "Vulnérable", color: "#FFCC00" },
        "NT": { name: "Quasi menacé", color: "#99CC33" },
        "LC": { name: "Préoccupation mineure", color: "#339900" },
        "DD": { name: "Données insuffisantes", color: "#CCCCCC" },
        "NE": { name: "Non évalué", color: "#FFFFFF" }
      };
      for (const [status, info] of Object.entries(iucnStatuses)) {
        const legendItem = document.createElement('div');
        legendItem.className = 'iucn-legend-item';
        const legendColor = document.createElement('div');
        legendColor.className = 'iucn-legend-color';
        legendColor.style.backgroundColor = info.color;
        const legendText = document.createElement('span');
        legendText.textContent = info.name;
        legendItem.appendChild(legendColor);
        legendItem.appendChild(legendText);
        legendContent.appendChild(legendItem);
      }
    }

    window.filterSpecies = filterSpecies;
    window.showSpeciesDetails = showSpeciesDetails;

    const searchInput = document.getElementById('searchBox');

    searchInput.addEventListener('input', function (e) {
      const query = e.target.value.toLowerCase().trim();
      dropdown.innerHTML = '';
      if (!query || query.length < 1) {
        dropdown.style.display = 'none';
        return;
      }

      const results = [];
      Object.keys(parkLayers).forEach(parkName => {
        if (parkName.toLowerCase().includes(query)) {
          results.push({
            type: 'park',
            name: parkName
          });
        }
      });

      observationsData.forEach(observation => {
        const speciesName = observation["Nom vernaculaire"] ? observation["Nom vernaculaire"].toLowerCase() : "";
        if (speciesName.includes(query)) {
          results.push({
            type: 'species',
            name: observation["Nom vernaculaire"],
            park: observation["Nom de l'espace"],
            observation: observation
          });
        }
      });

      if (results.length > 0) {
        results.forEach(result => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          if (result.type === 'park') {
            item.textContent = `Parc: ${result.name}`;
            item.onclick = function() {
              zoomToPark(result.name);
              dropdown.style.display = 'none';
            };
          } else {
            item.textContent = `Espèce: ${result.name} (Parc: ${result.park})`;
            item.onclick = function() {
              showSpeciesDetails(result.observation);
              zoomToPark(result.park);
              dropdown.style.display = 'none';
            };
          }
          dropdown.appendChild(item);
        });
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    });
  </script>
</body>
</html>
